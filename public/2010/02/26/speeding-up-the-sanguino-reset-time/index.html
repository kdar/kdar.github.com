<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  
  <meta property="og:type" content="article">
  <meta property="og:title" content="Speeding up the Sanguino reset time | Kevin Darlington">
  <meta property="og:url" content="http://192.168.0.2/2010/02/26/speeding-up-the-sanguino-reset-time/">
  <meta property="og:description" content="I decided to use a Sanguino for my next project and I noticed that every time I reset it with the pushbutton, it would take around 10 seconds to start the program. I thought this was absurd since the regular Arduino doesn&rsquo;t take that long. I decided to dive into the bootloader firmware and find out the problem. The Sanguino version I&rsquo;m dealing with is v1.4 r1.
">
  
  
  <meta property="og:site_name" content="Kevin Darlington">

  <meta name="generator" content="Hugo 0.16-DEV" />

  <title>
    
    Speeding up the Sanguino reset time | Kevin Darlington
    
  </title>

  <link rel="shortcut icon" href="http://192.168.0.2/favicon.ico" />
  <link rel="stylesheet" type="text/css" href='http://192.168.0.2/css/main.css'/>
</head>
<body>

  
  <div class="ui large top fixed hidden menu">
    <div class="ui container">
      <a class="item" href="http://192.168.0.2">Home</a>
<a class="item" href="http://192.168.0.2/post">All entries</a>
<a class="item" href="http://192.168.0.2/tags">Tags</a>

      <div class="right menu">
        <div class="item">
          <a class="ui blue button">Github</a>
        </div>
      </div>
    </div>
  </div>

  
  <div class="ui vertical inverted sidebar menu left">
    <a class="item" href="http://192.168.0.2">Home</a>
<a class="item" href="http://192.168.0.2/post">All entries</a>
<a class="item" href="http://192.168.0.2/tags">Tags</a>

    <a class="item">Github</a>
  </div>


  <div class="pusher">
    
    <div id="masthead">
  <div class="ui vertical masthead center aligned segment">
    <div class="ui container menu-wrapper">
      <div class="ui large inverted secondary pointing menu">
        <a class="header item" href="http://192.168.0.2">
          <img src="http://192.168.0.2/images/layout/kdar-logo-white.png">
        </a>
        <a class="toc item">
          <i class="sidebar icon"></i>
        </a>
        <a class="item" href="http://192.168.0.2">Home</a>
<a class="item" href="http://192.168.0.2/post">All entries</a>
<a class="item" href="http://192.168.0.2/tags">Tags</a>

        <div class="right item">
          <a class="ui inverted blue button">Github</a>
        </div>
      </div>
    </div>

    <div class="ui text container">
      <h1 class="ui inverted header">
        Kevin Darlington
      </h1>
      <h2 class="ui inverted header">Hello World!</h2>
    </div>
  </div>
</div>

    <div></div>


<div class="single-post-container inner">
  <article class="post post-single">
    <div class="post-media">
      <img src="http://192.168.0.2/images/posts/sanguinospeed/postmedia.jpg" alt="Speeding up the Sanguino reset time">
    </div>

    <div class="post-box">
      <header class="post-header">
        <h2 class="post-title"><a href="http://192.168.0.2/2010/02/26/speeding-up-the-sanguino-reset-time/">Speeding up the Sanguino reset time</a></h2>
        <div class="post-meta">
          <div class="post-reading-time"><i class="small clock icon"></i><span>3 min</span></div>
        </div>
      </header>
      <div class="post-content">
        <p>

<p>I decided to use a <a href="http://sanguino.cc/">Sanguino</a> for my next project and I noticed that every time I reset it with the pushbutton, it would take around 10 seconds to start the program. I thought this was absurd since the regular Arduino doesn&rsquo;t take that long. I decided to dive into the bootloader firmware and find out the problem. The Sanguino version I&rsquo;m dealing with is v1.4 r1.</p>

<p>After looking at the code, I could see that it would wait for &ldquo;MAX_TIME_COUNT&rdquo; iterations for a response on UART. Looking at the Makefile, it was set to 8000000&gt;&gt;1 which is the equivalent of 4000000. So the getch() function would keep incrementing a counter and checking for a response on UART, and finally timeout when the count exceeded 4000000. Obviously, this was taking too long for my tastes.</p>

<h4 id="changes:0c34f6de3ee3d07b958c07290019806f">Changes</h4>

<p>In the Makefile contained in hardware/sanguino/bootloaders/atmega644p, make the following changes:</p>

<ol>
<li><p>Change line 21 to point to an avr-gcc that is of version 3.x.x (not needed for OSX)</p></li>

<li><p>On line 33, change &ldquo;8000000&gt;&gt;1&rdquo; to &ldquo;F_CPU&gt;&gt;4&rdquo;. Use &ldquo;F_CPU&gt;&gt;5&rdquo; if you want 0.5 seconds faster.</p>

<ol>
<li>On line 43, change &ldquo;avr-gcc&rdquo; to &ldquo;$(CC)&rdquo;</li>
</ol></li>
</ol>

<p>I have to explain the #1 part. The Sanguino bootloader was made to compile with the 3.x.x series of the gcc compiler. The newest versions of WinAVR and avr-gcc for osx/linux, use gcc 4.x.x. The bootloader will not compile correctly with this version. Here are some instructions on getting the 3.x.x version of avr-gcc:</p>

<ul>
<li><p>Windows: Download <a href="http://sourceforge.net/projects/winavr/files/WinAVR/20060421/">WinAVR-20060421</a>. It contains avr-gcc 3.4.6</p></li>

<li><p>OSX: Type &ldquo;avr-gcc-select 3&rdquo; in a terminal. Be sure to change it back to &ldquo;avr-gcc-select 4&rdquo; when you&rsquo;re done compiling.</p></li>

<li><p>Linux: Download<a href="http://ftp.gnu.org/gnu/gcc/gcc-3.4.6/gcc-3.4.6.tar.gz"> gcc-3.4.6</a> and apply this <a href="http://www.freebsd.org/cgi/cvsweb.cgi/~checkout~/ports/devel/avr-gcc/files/patch-  newdevices?rev=1.12;content-type=text/plain">patch</a>.</p></li>
</ul>

<p>I only tested this on Windows, so I cannot say if the OSX and Linux solutions will work.</p>

<p>I also changed the ATmegaBOOT.c code to not blink the LED 3 times but to blink it once. I saved some precious milliseconds. You can do this be setting NUM_LED_FLASHES on line 77 to 1.</p>

<h4 id="compiling-and-uploading:0c34f6de3ee3d07b958c07290019806f">Compiling and uploading</h4>

<p>Just run &ldquo;make&rdquo; in the atmega644p folder to build the hex file. If your hex file ends up being over 6KB, then you&rsquo;re still using gcc 4.x.x and not 3.x.x.</p>

<p>To upload the bootloader, I used the Arduino IDE and went to Tools &gt; Burn Bootloader &gt; USBtinyISP. Select whatever programmer you have. Make sure you have &ldquo;Sanguino&rdquo; as the selected board in Tools &gt; Board.</p>

<h4 id="speed-comparison:0c34f6de3ee3d07b958c07290019806f">Speed comparison</h4>

<p>Before: ~10.5 seconds reset time</p>

<p>With F_CPU&gt;&gt;4: ~2.5 seconds reset time</p>

<p>With F_CPU&gt;&gt;5: ~2 seconds reset time</p>

<h4 id="conclusion:0c34f6de3ee3d07b958c07290019806f">Conclusion</h4>

<p>I&rsquo;m unsure why the delay is so long in the Makefile. Currently, I see no ill effects from making this change. Be sure not to make the delay too low because then you won&rsquo;t be able to serially program the device.</p>

<h4 id="files:0c34f6de3ee3d07b958c07290019806f">Files</h4>

<p><a href="/downloads/wp-content/uploads/2010/02/Makefile">Makefile</a></p>

<p><a href="/downloads/wp-content/uploads/2010/02/ATmegaBOOT.c">ATmegaBOOT.c</a></p>
</p>

        <div class="post-tags">
          
          <div class="ui tag label">Arduino</div>
          
          <div class="ui tag label">Electronics</div>
          
          <div class="ui tag label">Microcontrollers</div>
          
        </div>
      </div>
    </div>
    <div class="post-footer-wrapper">
      <div class="post-footer">
        <div class="post-footer-left">Fri, Feb 26, 2010</div>
        <div class="post-spacer"></div>
        <div class="post-footer-right">Kevin Darlington</div>
      </div>
    </div>

    <aside>
      <div class="post-share">
        <h3>Share</h3>
        <a id="share-fb" href="http://www.facebook.com/sharer.php?src=bm&u=http%3a%2f%2f192.168.0.2%2f2010%2f02%2f26%2fspeeding-up-the-sanguino-reset-time%2f&t=Speeding%20up%20the%20Sanguino%20reset%20time" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><img src="http://192.168.0.2/images/sharebutton/facebook.png" alt="Facebook"/></a>
        <a id="share-twitter" href="http://twitter.com/intent/tweet?url=http%3a%2f%2f192.168.0.2%2f2010%2f02%2f26%2fspeeding-up-the-sanguino-reset-time%2f&text=Speeding%20up%20the%20Sanguino%20reset%20time&tw_p=tweetbutton" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><img src="http://192.168.0.2/images/sharebutton/twitter.png" alt="Twitter"/></a>
        <a id="share-googleplus" href="https://plus.google.com/share?url=http%3a%2f%2f192.168.0.2%2f2010%2f02%2f26%2fspeeding-up-the-sanguino-reset-time%2f" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><img src="http://192.168.0.2/images/sharebutton/googleplus.png" alt="Google+"/></a>
        <a id="share-hatena" href="http://b.hatena.ne.jp/add?mode=confirm&url=http%3a%2f%2f192.168.0.2%2f2010%2f02%2f26%2fspeeding-up-the-sanguino-reset-time%2f" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><img src="http://192.168.0.2/images/sharebutton/hatena.png" alt="Hatena"/></a>
        <a id="share-pocket" href="http://getpocket.com/edit?url=http%3a%2f%2f192.168.0.2%2f2010%2f02%2f26%2fspeeding-up-the-sanguino-reset-time%2f&title=Speeding%20up%20the%20Sanguino%20reset%20time" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><img src="http://192.168.0.2/images/sharebutton/pocket.png" alt="Pocket"/></a>
      </div>
    </aside>
  </article>

  

  <div class="prevnext">
    
    <a href="http://192.168.0.2/2010/02/26/stm32-project-template-for-hd-devices/" class="ui left labeled icon button violet prev">
      <i class="left arrow icon"></i>
      STM32 Project template for HD devices
    </a>
    
    
    <a href="http://192.168.0.2/2010/02/23/repurposed-tv-b-gone-to-turn-off-benq-projector/" class="ui right labeled icon button blue next">
      <i class="right arrow icon"></i>
      Repurposed tv-b-gone to turn off benq projector
    </a>
    
  </div>

  <footer>
    
  </footer>

  <div class="comments-area">
    <h3 class="comments-title">Comments</h3>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'kdarsblog';
    var disqus_identifier = 'http:\/\/192.168.0.2\/2010\/02\/26\/speeding-up-the-sanguino-reset-time\/';
    var disqus_title = 'Speeding up the Sanguino reset time';
    var disqus_url = 'http:\/\/192.168.0.2\/2010\/02\/26\/speeding-up-the-sanguino-reset-time\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>

    <div class="ui inverted vertical footer segment">
      <div class="ui container">
        <div class="ui stackable inverted divided equal height stackable grid">
          <div class="twelve wide column">
            <div class="ui inverted link list">
              <p>&copy; 2013  Kevin Darlington </p>
              <p>Powered by <a href="http://gohugo.io" target="_blank" class="item">Hugo</a>, designed by <a href="http://github.com/kdar" target="_blank" class="item">Kevin Darlington</a></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  
  <script src="http://192.168.0.2/js/main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/salvattore/1.0.9/salvattore.min.js"></script>
</body>
</html>

